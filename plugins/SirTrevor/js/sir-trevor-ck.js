/*!
 * Sir Trevor JS v0.3.0-rc.5
 *
 * Released under the MIT license
 * www.opensource.org/licenses/MIT
 *
 * 2013-10-21
 */(function(e,t){function i(t){return t instanceof e?t:e(t)}function a(e,t){var n=-1,r=-1,i=t.length,s=e.length;for(var o=0;o<i;o++){n==-1&&e.substr(o,1)!=t.substr(o,1)&&(n=o-1);r==-1&&e.substr(s-o-1,1)!=t.substr(i-o-1,1)&&(r=o)}return{result:t.substr(n,i-r-n+1),pos1:n,pos2:r}}var n=this,r;r=n.SirTrevor={};r.DEBUG=!1;r.SKIP_VALIDATION=!1;r.version="0.3.0-rc.5";r.DEFAULTS={defaultType:!1,spinner:{className:"st-spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/",errorsContainer:undefined};r.BlockMixins={};r.Blocks={};r.Formatters={};r.instances=[];r.Events=Eventable;var s=!1,o={bound:[],_bindFunctions:function(){this.bound.length>0&&t.bindAll.apply(null,t.union(this,this.bound))}},u={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(e){return this.$el.find(e)},render:function(){return this},_ensureElement:function(){if(!this.el){var n=t.extend({},t.result(this,"attributes")),r;this.id&&(n.id=this.id);this.className&&(n["class"]=this.className);if(n.html){r=n.html;delete n.html}var i=e("<"+this.tagName+">").attr(n);r&&i.html(r);this._setElement(i)}else this._setElement(this.el)},_setElement:function(e){this.$el=i(e);this.el=this.$el[0];return this}};(function(e){function t(e){e.preventDefault()}function n(t){t.originalEvent.dataTransfer.dropEffect="copy";e(t.currentTarget).addClass("st-drag-over");t.preventDefault()}function r(t){e(t.currentTarget).removeClass("st-drag-over");t.preventDefault()}e.fn.dropArea=function(){this.bind("dragenter",t).bind("dragover",n).bind("dragleave",r);return this};e.fn.noDropArea=function(){this.unbind("dragenter").unbind("dragover").unbind("dragleave");return this};e.fn.caretToEnd=function(){var e,t;e=document.createRange();e.selectNodeContents(this[0]);e.collapse(!1);t=window.getSelection();t.removeAllRanges();t.addRange(e);return this}})(jQuery);var f=function(e,n){var r=this,i;e&&t.has(e,"constructor")?i=e.constructor:i=function(){return r.apply(this,arguments)};t.extend(i,r,n);var s=function(){this.constructor=i};s.prototype=r.prototype;i.prototype=new s;e&&t.extend(i.prototype,e);i.__super__=r.prototype;return i};r.log=function(e){!t.isUndefined(console)&&r.DEBUG&&console.log(e)};(function(e,t,n){function r(e,n){var r=t.createElement(e||"div"),i;for(i in n)r[i]=n[i];return r}function i(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function s(e,t,n,r){var i=["opacity",t,~~(e*100),n,r].join("-"),s=.01+n/r*100,o=Math.max(1-(1-e)/t*(100-s),e),u=h.substring(0,h.indexOf("Animation")).toLowerCase(),a=u&&"-"+u+"-"||"";return c[i]||(p.insertRule("@"+a+"keyframes "+i+"{"+"0%{opacity:"+o+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+o+"}"+"}",0),c[i]=1),i}function o(e,t){var r=e.style,i,s;if(r[t]!==n)return t;t=t.charAt(0).toUpperCase()+t.slice(1);for(s=0;s<l.length;s++){i=l[s]+t;if(r[i]!==n)return i}}function u(e,t){for(var n in t)e.style[o(e,n)||n]=t[n];return e}function a(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)e[i]===n&&(e[i]=r[i])}return e}function f(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}var l=["webkit","Moz","ms","O"],c={},h,p=function(){var e=r("style");return i(t.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),d={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},v=function m(e){if(!this.spin)return new m(e);this.opts=a(e||{},m.defaults,d)};v.defaults={},a(v.prototype,{spin:function(e){this.stop();var t=this,n=t.opts,i=t.el=u(r(0,{className:n.className}),{position:"relative",zIndex:n.zIndex}),s=n.radius+n.length+n.width,o,a;e&&(e.insertBefore(i,e.firstChild||null),a=f(e),o=f(i),u(i,{left:(n.left=="auto"?a.x-o.x+(e.offsetWidth>>1):n.left+s)+"px",top:(n.top=="auto"?a.y-o.y+(e.offsetHeight>>1):n.top+s)+"px"})),i.setAttribute("aria-role","progressbar"),t.lines(i,t.opts);if(!h){var l=0,c=n.fps,p=c/n.speed,d=(1-n.opacity)/(p*n.trail/100),v=p/n.lines;!function m(){l++;for(var e=n.lines;e;e--){var r=Math.max(1-(l+e*v)%p*d,n.opacity);t.opacity(i,n.lines-e,r,n)}t.timeout=t.el&&setTimeout(m,~~(1e3/c))}()}return t},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=n),this},lines:function(e,t){function n(e,n){return u(r(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*o+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.width>>1)+"px"})}var o=0,a;for(;o<t.lines;o++)a=u(r(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:h&&s(t.opacity,t.trail,o,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&i(a,u(n("#000","0 0 4px #000"),{top:"2px"})),i(e,i(a,n(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}}),!function(){function e(e,t){return r("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=u(r("group"),{behavior:"url(#default#VML)"});!o(t,"transform")&&t.adj?(p.addRule(".spin-vml","behavior:url(#default#VML)"),v.prototype.lines=function(t,n){function r(){return u(e("group",{coordsize:a+" "+a,coordorigin:-o+" "+ -o}),{width:a,height:a})}function s(t,s,a){i(l,i(u(r(),{rotation:360/n.lines*t+"deg",left:~~s}),i(u(e("roundrect",{arcsize:1}),{width:o,height:n.width,left:n.radius,top:-n.width>>1,filter:a}),e("fill",{color:n.color,opacity:n.opacity}),e("stroke",{opacity:0}))))}var o=n.length+n.width,a=2*o,f=-(n.width+n.length)*2+"px",l=u(r(),{position:"absolute",top:f,left:f}),c;if(n.shadow)for(c=1;c<=n.lines;c++)s(c,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(c=1;c<=n.lines;c++)s(c);return i(t,l)},v.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}):h=o(t,"animation")}(),e.Spinner=v})(window,document);r.editorStore=function(e,n,r){var i;r=r||{};switch(n){case"create":var s=t.trim(e.$el.val());e.dataStore={data:[]};if(s.length>0)try{var o=JSON.parse(s);t.isUndefined(o.data)||(e.dataStore=o)}catch(u){e.errors.push({text:"There was a problem loading the contents of the document"});e.renderErrors();console.log("Sorry there has been a problem with parsing the JSON");console.log(u)}break;case"reset":e.dataStore={data:[]};break;case"add":if(r.data){e.dataStore.data.push(r.data);i=e.dataStore}break;case"save":e.$el.val(e.dataStore.data.length>0?JSON.stringify(e.dataStore):"");break;case"read":i=e.dataStore}if(i)return i};var l=function(){this.intialize()};t.extend(l.prototype,{intialize:function(){this.submitBtn=e("input[type='submit']");var n=[];t.each(this.submitBtn,function(t){n.push(e(t).attr("value"))});this.submitBtnTitles=n;this.canSubmit=!0;this.globalUploadCount=0;this._bindEvents()},setSubmitButton:function(e,t){this.submitBtn.attr("value",t)},resetSubmitButton:function(){t.each(this.submitBtn,function(t,n){e(t).attr("value",this.submitBtnTitles[n])},this)},onUploadStart:function(e){this.globalUploadCount++;r.log("onUploadStart called "+this.globalUploadCount);this.globalUploadCount===1&&this._disableSubmitButton()},onUploadStop:function(e){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1;r.log("onUploadStop called "+this.globalUploadCount);this.globalUploadCount===0&&this._enableSubmitButton()},onError:function(e){r.log("onError called");this.canSubmit=!1},_disableSubmitButton:function(e){this.setSubmitButton(null,e||"Please wait...");this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton();this.submitBtn.removeAttr("disabled").removeClass("disabled")},_events:{disableSubmitButton:"_disableSubmitButton",enableSubmitButton:"_enableSubmitButton",setSubmitButton:"setSubmitButton",resetSubmitButton:"resetSubmitButton",onError:"onError",onUploadStart:"onUploadStart",onUploadStop:"onUploadStop"},_bindEvents:function(){t.forEach(this._events,function(e,t){r.EventBus.on(t,this[e],this)},this)}});r.submittable=function(){new l};r.fileUploader=function(n,i,s,o){r.EventBus.trigger("onUploadStart");var u=[n.blockID,(new Date).getTime(),"raw"].join("-"),a=new FormData;a.append("attachment[name]",i.name);a.append("attachment[file]",i);a.append("attachment[uid]",u);n.resetMessages();var f=function(e){r.log("Upload callback called");r.EventBus.trigger("onUploadStop");!t.isUndefined(s)&&t.isFunction(s)&&t.bind(s,n)(e)},l=function(e,i,s){r.log("Upload callback error called");r.EventBus.trigger("onUploadStop");!t.isUndefined(o)&&t.isFunction(o)&&t.bind(o,n)(i)},c=e.ajax({url:r.DEFAULTS.uploadUrl,data:a,cache:!1,contentType:!1,processData:!1,type:"POST"});n.addQueuedItem(u,c);c.done(f).fail(l).always(t.bind(n.removeQueuedItem,n,u));return c};var c=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;t.mixin({isURI:function(e){return c.test(e)},capitalize:function(e){return e.charAt(0).toUpperCase()+e.substring(1).toLowerCase()},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(e){return e.split("").reverse().join("")},flattern:function(e){var n={};t.each(e,function(r,i){n[t.isArray(e)?r:i]=!0});return n},to_slug:function(e){return e.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}});r.toHTML=function(e,n){var i=e,s=n==="Text";t.isUndefined(s)&&(s=!1);s&&(i="<div>"+i);i=i.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(e,t,n){return"<a href='"+n+"'>"+t.replace(/\n/g,"")+"</a>"});i=t.reverse(t.reverse(i).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(e,t){return">i/<"+t.replace(/\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(e,t){return">b/<"+t.replace(/\n/g,"").replace(/[\s]+$/,"")+">b<"}));i=i.replace(/^\> (.+)$/mg,"$1");var o,u;for(o in this.formatters)if(r.Formatters.hasOwnProperty(o)){u=r.Formatters[o];!t.isUndefined(u.toHTML)&&t.isFunction(u.toHTML)&&(i=u.toHTML(i))}var a;if(r.Blocks.hasOwnProperty(n)){a=r.Blocks[n];!t.isUndefined(a.prototype.toHTML)&&t.isFunction(a.prototype.toHTML)&&(i=a.prototype.toHTML(i))}if(s){i=i.replace(/\n\n/gm,"</div><div><br></div><div>");i=i.replace(/\n/gm,"</div><div>")}i=i.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\n/g,"<br>").replace(/\*\*/,"").replace(/__/,"");i=i.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-");s&&(i+="</div>");return i};r.toMarkdown=function(e,n){function f(e,n,r){t.isUndefined(r)&&(r="");return"**"+n.replace(/<(.)?br(.)?>/g,"")+"**"+r}function l(e,n,r){t.isUndefined(r)&&(r="");return"_"+n.replace(/<(.)?br(.)?>/g,"")+"_"+r}var i=e;i=i.replace(/&nbsp;/g," ");i=i.replace(/( class=(")?Mso[a-zA-Z]+(")?)/g,"").replace(/<!--(.*?)-->/g,"").replace(/\/\*(.*?)\*\//g,"").replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");var s=["style","script","applet","embed","noframes","noscript"],o,u;for(u=0;u<s.length;u++){o=new RegExp("<"+s[u]+".*?"+s[u]+"(.*?)>","gi");i=i.replace(o,"")}i=i.replace(/\*/g,"\\*").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\_/g,"\\_").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\-/g,"\\-");var a=["em","i","strong","b"];for(u=0;u<a.length;u++){o=new RegExp("<"+a[u]+"><br></"+a[u]+">","gi");i=i.replace(o,"<br>")}i=i.replace(/<(\w+)(?:\s+\w+="[^"]+(?:"\$[^"]+"[^"]+)?")*>\s*<\/\1>/gim,"").replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/gim,function(e,t,n){return"["+n.trim().replace(/<(.)?br(.)?>/g,"")+"]("+t+")"}).replace(/<strong>(?:\s*)(.*?)(\s)*?<\/strong>/gim,f).replace(/<b>(?:\s*)(.*?)(\s*)?<\/b>/gim,f).replace(/<em>(?:\s*)(.*?)(\s*)?<\/em>/gim,l).replace(/<i>(?:\s*)(.*?)(\s*)?<\/i>/gim,l);var c,h;for(c in this.formatters)if(r.Formatters.hasOwnProperty(c)){h=r.Formatters[c];!t.isUndefined(h.toMarkdown)&&t.isFunction(h.toMarkdown)&&(i=h.toMarkdown(i))}i=i.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">");var p;if(r.Blocks.hasOwnProperty(n)){p=r.Blocks[n];!t.isUndefined(p.prototype.toMarkdown)&&t.isFunction(p.prototype.toMarkdown)&&(i=p.prototype.toMarkdown(i))}i=i.replace(/<\/?[^>]+(>|$)/g,"");return i};r.EventBus=t.extend({},r.Events);r.BlockMixins.Ajaxable={mixinName:"Ajaxable",ajaxable:!0,initializeAjaxable:function(){this._queued=[]},addQueuedItem:function(e,t){r.log("Adding queued item for "+this.blockID+" called "+e);this._queued.push({name:e,deffered:t})},removeQueuedItem:function(e){r.log("Removing queued item for "+this.blockID+" called "+e);this._queued=t.reject(this._queued,function(t){return t.name==e})},hasItemsInQueue:function(){return this._queued.length>0},resolveAllInQueue:function(){t.each(this._queued,function(e){r.log("Aborting queued request: "+e.name);e.deffered.abort()},this)}};r.BlockMixins.Droppable={mixinName:"Droppable",valid_drop_file_types:["File","Files","text/plain","text/uri-list"],initializeDroppable:function(){r.log("Adding droppable to block "+this.blockID);this.drop_options=t.extend({},r.DEFAULTS.Block.drop_options,this.drop_options);var n=e(t.template(this.drop_options.html,{block:this}));this.$editor.hide();this.$inputs.append(n);this.$dropzone=n;this.$dropzone.dropArea().bind("drop",t.bind(this._handleDrop,this));this.$inner.addClass("st-block__inner--droppable")},_handleDrop:function(n){n.preventDefault();n=n.originalEvent;var i=e(n.target),s=n.dataTransfer.types,o,u=[];i.removeClass("st-dropzone--dragover");!t.isUndefined(s)&&t.some(s,function(e){return t.include(this.valid_drop_file_types,e)},this)&&this.onDrop(n.dataTransfer);r.EventBus.trigger("block:content:dropped")}};r.BlockMixins.Fetchable={mixinName:"Fetchable",initializeFetchable:function(){this.withMixin(r.BlockMixins.Ajaxable)},fetch:function(n,r,i){var s=t.uniqueId(this.blockID+"_fetch"),o=e.ajax(n);this.resetMessages();this.addQueuedItem(s,o);t.isUndefined(r)||o.done(t.bind(r,this));t.isUndefined(i)||o.fail(t.bind(i,this));o.always(t.bind(this.removeQueuedItem,this,s));return o}};r.BlockMixins.Pastable={mixinName:"Pastable",initializePastable:function(){r.log("Adding pastable to block "+this.blockID);this.paste_options=t.extend({},r.DEFAULTS.Block.paste_options,this.paste_options);this.$inputs.append(t.template(this.paste_options.html,this));this.$(".st-paste-block").bind("click",function(){e(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}};r.BlockMixins.Uploadable={mixinName:"Uploadable",uploadsCount:0,initializeUploadable:function(){r.log("Adding uploadable to block "+this.blockID);this.withMixin(r.BlockMixins.Ajaxable);this.upload_options=t.extend({},r.DEFAULTS.Block.upload_options,this.upload_options);this.$inputs.append(t.template(this.upload_options.html,this))},uploader:function(e,t,n){return r.fileUploader(this,e,t,n)}};r.BlockPositioner=function(){var e=["<div class='st-block-positioner__inner'>","<span class='st-block-positioner__selected-value'></span>","<select class='st-block-positioner__select'></select>","</div>"].join("\n"),n=function(e,t){this.$block=e;this.instanceID=t;this.total_blocks=0;this._ensureElement();this._bindFunctions();this.initialize()};t.extend(n.prototype,o,u,{bound:["onBlockCountChange","onSelectChange","toggle","show","hide"],className:"st-block-positioner",visibleClass:"st-block-positioner--is-visible",initialize:function(){this.$el.append(e);this.$select=this.$(".st-block-positioner__select");this.$select.on("change",this.onSelectChange);r.EventBus.on(this.instanceID+":blocks:count_update",this.onBlockCountChange)},onBlockCountChange:function(e){if(e!=this.total_blocks){this.total_blocks=e;this.renderPositionList()}},onSelectChange:function(){var e=this.$select.val();if(e!==0){r.EventBus.trigger(this.instanceID+":blocks:change_position",this.$block,e,e==1?"before":"after");this.toggle()}},renderPositionList:function(){var e="<option value='0'>Position</option>";for(var t=1;t<=this.total_blocks;t++)e+="<option value="+t+">"+t+"</option>";this.$select.html(e)},toggle:function(){this.$select.val(0);this.$el.toggleClass(this.visibleClass)},show:function(){this.$el.addClass(this.visibleClass)},hide:function(){this.$el.removeClass(this.visibleClass)}});return n}();r.BlockReorder=function(){var n=function(e){this.$block=e;this._ensureElement();this._bindFunctions();this.initialize()};t.extend(n.prototype,o,u,{bound:["onMouseDown","onClick","onDragStart","onDragEnd","onDrag","onDrop"],className:"st-block-ui-btn st-block-ui-btn--reorder st-icon",tagName:"a",attributes:function(){return{html:"reorder",draggable:"true","data-icon":"move"}},initialize:function(){this.$el.bind("mousedown touchstart",this.onMouseDown).bind("click",this.onClick).bind("dragstart",this.onDragStart).bind("dragend touchend",this.onDragEnd).bind("drag touchmove",this.onDrag);this.$block.dropArea().bind("drop",this.onDrop)},onMouseDown:function(){r.EventBus.trigger("block:reorder:down")},onDrop:function(n){n.preventDefault();var i=this.$block,s=n.originalEvent.dataTransfer.getData("text/plain"),o=e("#"+s);!t.isUndefined(s)&&!t.isEmpty(o)&&i.attr("id")!=s&&i.attr("data-instance")==o.attr("data-instance")&&i.after(o);r.EventBus.trigger("block:reorder:dropped",s)},onDragStart:function(t){var n=e(t.currentTarget).parent();t.originalEvent.dataTransfer.setDragImage(this.$block[0],n.position().left,n.position().top);t.originalEvent.dataTransfer.setData("Text",this.$block.attr("id"));r.EventBus.trigger("block:reorder:dragstart");this.$block.addClass("st-block--dragging")},onDragEnd:function(e){r.EventBus.trigger("block:reorder:dragend");this.$block.removeClass("st-block--dragging")},onDrag:function(e){},onClick:function(){},render:function(){return this}});return n}();r.BlockDeletion=function(){var e=function(){this._ensureElement();this._bindFunctions()};t.extend(e.prototype,o,u,{tagName:"a",className:"st-block-ui-btn st-block-ui-btn--delete st-icon",attributes:{html:"delete","data-icon":"bin"}});return e}();var h=function(e){var n=e.attr("data-st-name")||e.attr("name");n||(n="Field");return t.capitalize(n)};r.BlockValidations={errors:[],valid:function(){this.performValidations();return this.errors.length===0},performValidations:function(){this.resetErrors();var e=this.$(".st-required");t.each(e,this.validateField,this);t.each(this.validations,this.runValidator,this);this.$el.toggleClass("st-block--with-errors",this.errors.length>0)},validations:[],validateField:function(t){t=e(t);var n=t.attr("contenteditable")?t.text():t.val();n.length===0&&this.setError(t,h(t)+" must not be empty")},runValidator:function(e){t.isUndefined(this[e])||this[e].call(this)},setError:function(e,t){var n=this.addMessage(t,"st-msg--error");e.addClass("st-error");this.errors.push({field:e,reason:t,msg:n})},resetErrors:function(){t.each(this.errors,function(e){e.field.removeClass("st-error");e.msg.remove()});this.$messages.removeClass("st-block__messages--is-visible");this.errors=[]}};r.BlockStore={blockStorage:{},createStore:function(e){this.blockStorage={type:this.type.toLowerCase(),data:e||{}}},save:function(){this.toData()},saveAndReturnData:function(){this.save();return this.blockStorage},getData:function(){return this.blockStorage.data},setData:function(e){r.log("Setting data for block "+this.blockID);t.extend(this.blockStorage.data,e||{})},setAndRetrieveData:function(e){this.setData(e);return this.getData()},setAndLoadData:function(e){this.setData(e);this.beforeLoadingData()},toData:function(){},loadData:function(){},beforeLoadingData:function(){r.log("loadData for "+this.blockID);r.EventBus.trigger("editor/block/loadData");this.loadData(this.getData())},_loadData:function(){r.log("_loadData is deprecated and will be removed in the future. Please use beforeLoadingData instead.");this.beforeLoadingData()},checkAndLoadData:function(){t.isEmpty(this.getData())||this.beforeLoadingData()}};r.SimpleBlock=function(){var n=function(e,n){this.createStore(e);this.blockID=t.uniqueId("st-block-");this.instanceID=n;this._ensureElement();this._bindFunctions();this.initialize.apply(this,arguments)};t.extend(n.prototype,o,r.Events,u,r.BlockStore,{focus:function(){},valid:function(){return!0},className:"st-block",block_template:t.template("<div class='st-block__inner'><%= editor_html %></div>"),attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID}},title:function(){return t.capitalize(this.type)},blockCSSClass:function(){this.blockCSSClass=t.to_slug(this.type);return this.blockCSSClass},type:"",editorHTML:"",initialize:function(){},onBlockRender:function(){},beforeBlockRender:function(){},_setBlockInner:function(){var e=t.result(this,"editorHTML");this.$el.append(this.block_template({editor_html:e}));this.$inner=this.$el.find(".st-block__inner");this.$inner.bind("click mouseover",function(e){e.stopPropagation()})},render:function(){this.beforeBlockRender();this._setBlockInner();this._blockPrepare();this.onBlockRender();return this},_blockPrepare:function(){this._initUI();this._initMessages();this.checkAndLoadData();this.$el.addClass("st-item-ready");this.save()},_withUIComponent:function(e,t,n){this.$ui.append(e.render().$el);t&&n&&this.$ui.on("click",t,n)},_initUI:function(){var t=e("<div>",{"class":"st-block__ui"});this.$inner.append(t);this.$ui=t;this._initUIComponents()},_initMessages:function(){var t=e("<div>",{"class":"st-block__messages"});this.$inner.prepend(t);this.$messages=t},addMessage:function(t,n){var r=e("<span>",{html:t,"class":"st-msg "+n});this.$messages.append(r).addClass("st-block__messages--is-visible");return r},resetMessages:function(){this.$messages.html("").removeClass("st-block__messages--is-visible")},_initUIComponents:function(){this._withUIComponent(new r.BlockReorder(this.$el))}});n.fn=n.prototype;n.extend=f;return n}();r.Block=function(){var n=function(e,t){r.SimpleBlock.apply(this,arguments)},i=["<div class='st-block__ui-delete-controls'>","<label class='st-block__delete-label'>Delete?</label>","<a class='st-block-ui-btn st-block-ui-btn--confirm-delete st-icon' data-icon='tick'></a>","<a class='st-block-ui-btn st-block-ui-btn--deny-delete st-icon' data-icon='close'></a>","</div>"].join("\n"),s={html:['<div class="st-block__dropzone">','<span class="st-icon"><%= _.result(block, "icon_name") %></span>',"<p>Drag <span><%= block.type %></span> here</p></div>"].join("\n"),re_render_on_reorder:!1},o={html:'<input type="text" placeholder="Or paste URL here" class="st-block__paste-input st-paste-block">'},u={html:['<div class="st-block__upload-container">','<input type="file" type="st-file-upload">','<button class="st-upload-btn">...or choose a file</button>',"</div>"].join("\n")};r.DEFAULTS.Block={drop_options:s,paste_options:o,upload_options:u};t.extend(n.prototype,r.SimpleBlock.fn,r.BlockValidations,{bound:["_handleContentPaste","_onFocus","_onBlur","onDrop","onDeleteClick","clearInsertedStyles","getSelectionForFormatter"],className:"st-block st-icon--add",attributes:function(){return t.extend(r.SimpleBlock.fn.attributes.call(this),{"data-icon-after":"add"})},icon_name:"default",validationFailMsg:function(){return this.type+" block is invalid"},editorHTML:'<div class="st-block__editor"></div>',toolbarEnabled:!0,droppable:!1,pastable:!1,uploadable:!1,fetchable:!1,ajaxable:!1,drop_options:{},paste_options:{},upload_options:{},formattable:!0,initialize:function(){},toMarkdown:function(e){return e},toHTML:function(e){return e},withMixin:function(e){if(!t.isObject(e))return;var n="initialize"+e.mixinName;if(t.isUndefined(this[n])){t.extend(this,e);this[n]()}},render:function(){this.beforeBlockRender();this._setBlockInner();this.$editor=this.$inner.children().first();if(this.droppable||this.pastable||this.uploadable){var t=e("<div>",{"class":"st-block__inputs"});this.$inner.append(t);this.$inputs=t}this.hasTextBlock&&this._initTextBlocks();this.droppable&&this.withMixin(r.BlockMixins.Droppable);this.pastable&&this.withMixin(r.BlockMixins.Pastable);this.uploadable&&this.withMixin(r.BlockMixins.Uploadable);this.fetchable&&this.withMixin(r.BlockMixins.Fetchable);this.formattable&&this._initFormatting();this._blockPrepare();this.onBlockRender();return this},remove:function(){this.$el.remove()},loading:function(){t.isUndefined(this.spinner)||this.ready();this.spinner=new Spinner(r.DEFAULTS.spinner);this.spinner.spin(this.$el[0]);this.$el.addClass("st--is-loading")},ready:function(){this.$el.removeClass("st--is-loading");if(!t.isUndefined(this.spinner)){this.spinner.stop();delete this.spinner}},toData:function(){r.log("toData for "+this.blockID);var n=this.$el,i={};if(this.hasTextBlock()){var s=this.getTextBlock().html();s.length>0&&(i.text=r.toMarkdown(s,this.type))}var o=!t.isUndefined(i.text)||!this.hasTextBlock();this.$('input[type="text"]').not(".st-paste-block").length>0&&this.$('input[type="text"]').each(function(t,n){n=e(n);o&&(i[n.attr("name")]=n.val())});t.isEmpty(i)||this.setData(i)},focus:function(){this.getTextBlock().focus()},blur:function(){this.getTextBlock().blur()},onFocus:function(){this.getTextBlock().bind("focus",this._onFocus)},onBlur:function(){this.getTextBlock().bind("blur",this._onBlur)},_onFocus:function(){this.trigger("blockFocus",this.$el)},_onBlur:function(){},onDrop:function(e){},onDeleteClick:function(e){e.preventDefault();this.$inner.append(i);this.$el.addClass("st-block--delete-active");var n=this.$inner.find(".st-block__ui-delete-controls"),r=function(e){e.preventDefault();this.trigger("removeBlock",this.blockID)},s=function(e){e.preventDefault();this.$el.removeClass("st-block--delete-active");n.remove()};this.$inner.on("click",".st-block-ui-btn--confirm-delete",t.bind(r,this)).on("click",".st-block-ui-btn--deny-delete",t.bind(s,this))},pastedMarkdownToHTML:function(e){return r.toHTML(r.toMarkdown(e,this.type),this.type)},onContentPasted:function(e,t){t.html(this.pastedMarkdownToHTML(t[0].innerHTML));this.getTextBlock().caretToEnd()},beforeLoadingData:function(){this.loading();if(this.droppable||this.uploadable||this.pastable){this.$editor.show();this.$inputs.hide()}r.SimpleBlock.fn.beforeLoadingData.call(this);this.ready()},_handleContentPaste:function(n){var r=e(n.currentTarget);t.delay(t.bind(this.onContentPasted,this,n,r),0)},_getBlockClass:function(){return"st-block--"+this.className},_initUIComponents:function(){var e=new r.BlockPositioner(this.$el,this.instanceID);this._withUIComponent(e,".st-block-ui-btn--reorder",e.toggle);this._withUIComponent(new r.BlockReorder(this.$el));this._withUIComponent(new r.BlockDeletion,".st-block-ui-btn--delete",this.onDeleteClick);this.onFocus();this.onBlur()},_initFormatting:function(){var e;for(var n in r.Formatters)if(r.Formatters.hasOwnProperty(n)){e=r.Formatters[n];t.isUndefined(e.keyCode)||e._bindToBlock(this.$el)}},_initTextBlocks:function(){this.getTextBlock().bind("paste",this._handleContentPaste).bind("keyup",this.getSelectionForFormatter).bind("mouseup",this.getSelectionForFormatter).bind("DOMNodeInserted",this.clearInsertedStyles)},getSelectionForFormatter:function(){var e=window.getSelection();e.toString().trim()===""?r.EventBus.trigger("formatter:hide"):r.EventBus.trigger("formatter:positon")},clearInsertedStyles:function(e){var t=e.target;t.removeAttribute("style")},hasTextBlock:function(){return this.getTextBlock().length>0},getTextBlock:function(){t.isUndefined(this.text_block)&&(this.text_block=this.$(".st-text-block"));return this.text_block}});n.extend=f;return n}();r.Formatter=function(){var e=function(e){this.formatId=t.uniqueId("format-");this._configure(e||{});this.initialize.apply(this,arguments)},n=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];t.extend(e.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(e){return e},toHTML:function(e){return e},initialize:function(){},_configure:function(e){this.options&&(e=t.extend({},this.options,e));for(var r=0,i=n.length;r<i;r++){var s=n[r];e[s]&&(this[s]=e[s])}this.options=e},isActive:function(){return document.queryCommandState(this.cmd)},_bindToBlock:function(e){var t=this,n=!1;e.on("keyup",".st-text-block",function(e){if(e.which==17||e.which==224||e.which==91)n=!1}).on("keydown",".st-text-block",{formatter:t},function(e){if(e.which==17||e.which==224||e.which==91)n=!0;if(e.which==e.data.formatter.keyCode&&n===!0){document.execCommand(e.data.formatter.cmd,!1,!0);e.preventDefault();n=!1}})}});e.extend=f;return e}();r.Blocks.Quote=function(){var e=t.template(['<blockquote class="st-required st-text-block" contenteditable="true"></blockquote>','<label class="st-input-label">Credit</label>','<input maxlength="140" name="cite" placeholder="Credit" class="st-input-string st-required js-cite-input" type="text" />'].join("\n"));return r.Block.extend({type:"Quote",icon_name:"quote",editorHTML:function(){return e(this)},loadData:function(e){this.getTextBlock().html(r.toHTML(e.text,this.type));this.$(".js-cite-input").val(e.cite)},toMarkdown:function(e){return e.replace(/^(.+)$/mg,"> $1")}})}();r.Blocks.Embedly=function(){return r.Block.extend({type:"Embedly",key:"",droppable:!0,pastable:!0,fetchable:!0,icon_name:"embed",loadData:function(e){if(e.html){this.$editor.addClass("st-block__editor--with-sixteen-by-nine-media");this.$editor.html(e.html)}else e.type=="photo"&&this.$editor.html('<img src="'+e.url+'" />')},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleDropPaste(r)},handleDropPaste:function(e){if(!t.isURI(e)){r.log("Must be a URL");return}this.loading();var n=function(e){this.setAndLoadData(e);this.ready()},i=function(){this.ready()},s={url:this.buildAPIUrl(e),dataType:"jsonp"};this.fetch(s,t.bind(n,this),t.bind(i,this))},buildAPIUrl:function(e){return"//api.embed.ly/1/oembed?key="+this.key+"&url="+escape(e)},onDrop:function(e){this.handleDropPaste(e.getData("text/plain"))}})}();r.Blocks.Heading=r.Block.extend({type:"Heading",editorHTML:'<div class="st-required st-text-block st-text-block--heading" contenteditable="true"></div>',icon_name:"heading",loadData:function(e){this.getTextBlock().html(r.toHTML(e.text,this.type))}});r.Blocks.Image=r.Block.extend({type:"Image",droppable:!0,uploadable:!0,icon_name:"image",loadData:function(t){this.$editor.html(e("<img>",{src:t.file.url}))},onBlockRender:function(){this.$inputs.find("button").bind("click",function(e){e.preventDefault()});this.$inputs.find("input").on("change",t.bind(function(e){this.onDrop(e.currentTarget)},this))},onDrop:function(t){var n=t.files[0],i=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;if(/image/.test(n.type)){this.loading();this.$inputs.hide();this.$editor.html(e("<img>",{src:i.createObjectURL(n)})).show();r.EventBus.trigger("setSubmitButton",["Please wait..."]);this.uploader(n,function(e){this.setData(e);this.ready()},function(e){this.addMessage("There was a problem with your upload");this.ready()})}}});r.Blocks.Text=r.Block.extend({type:"Text",editorHTML:'<div class="st-required st-text-block" contenteditable="true"></div>',icon_name:"text",loadData:function(e){this.getTextBlock().html(r.toHTML(e.text,this.type))}});r.Blocks.Tweet=function(){var n=t.template(["<blockquote class='twitter-tweet' align='center'>","<p><%= text %></p>","&mdash; <%= user.name %> (@<%= user.screen_name %>)","<a href='<%= status_url %>' data-datetime='<%= created_at %>'><%= created_at %></a>","</blockquote>",'<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>'].join("\n"));return r.Block.extend({type:"Tweet",droppable:!0,pastable:!0,fetchable:!0,drop_options:{re_render_on_reorder:!0},fetchUrl:function(e){return"/tweets/?tweet_id="+e},icon_name:"twitter",loadData:function(e){t.isUndefined(e.status_url)&&(e.status_url="");this.$inner.find("iframe").remove();this.$inner.prepend(n(e))},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleTwitterDropPaste(r)},handleTwitterDropPaste:function(e){if(!this.validTweetUrl(e)){r.log("Invalid Tweet URL");return}var n=e.match(/[^\/]+$/);if(!t.isEmpty(n)){this.loading();n=n[0];var i={url:this.fetchUrl(n),dataType:"json"
};this.fetch(i,this.onTweetSuccess,this.onTweetFail)}},validTweetUrl:function(e){return t.isURI(e)&&e.indexOf("twitter")!==-1&&e.indexOf("status")!==-1},onTweetSuccess:function(e){var t={user:{profile_image_url:e.user.profile_image_url,profile_image_url_https:e.user.profile_image_url_https,screen_name:e.user.screen_name,name:e.user.name},id:e.id_str,text:e.text,created_at:e.created_at,entities:e.entities,status_url:"https://twitter.com/"+e.user.screen_name+"/status/"+e.id_str};this.setAndLoadData(t);this.ready()},onTweetFail:function(){this.addMessage("There was a problem fetching your tweet");this.ready()},onDrop:function(e){var t=e.getData("text/plain");this.handleTwitterDropPaste(t)}})}();r.Blocks.List=function(){var e='<div class="st-text-block" contenteditable="true"><ul><li></li></ul></div>';return r.Block.extend({type:"List",icon_name:"list",editorHTML:function(){return t.template(e,this)},loadData:function(e){this.getTextBlock().html("<ul>"+r.toHTML(e.text,this.type)+"</ul>")},onBlockRender:function(){this.checkForList=t.bind(this.checkForList,this);this.getTextBlock().on("click keyup",this.checkForList)},checkForList:function(){this.$("ul").length===0&&document.execCommand("insertUnorderedList",!1,!1)},toMarkdown:function(e){return e.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(e){e=e.replace(/^ - (.+)$/mg,"<li>$1</li>").replace(/\n/mg,"");return e},onContentPasted:function(e,t){var n=this.pastedMarkdownToHTML(t[0].innerHTML),r=this.$("ul").html(n);this.getTextBlock().caretToEnd()}})}();r.Blocks.Video=function(){var n=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;return r.Block.extend({type:"Video",droppable:!0,pastable:!0,icon_name:"video",loadData:function(e){this.$editor.addClass("st-block__editor--with-sixteen-by-nine-media");e.source=="youtube"||e.source=="youtu"?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+e.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):e.source=="vimeo"&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+e.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleDropPaste(r)},handleDropPaste:function(e){if(t.isURI(e))if(e.indexOf("youtu")!=-1||e.indexOf("vimeo")!=-1){var r={},i=e.match(n);if(i[3]!==undefined){r.source=i[3];r.remote_id=i[4]}else if(i[1]!==undefined){r.source=i[1];r.remote_id=i[2]}r.source=="youtu"&&(r.source="youtube");this.setAndLoadData(r)}},onDrop:function(e){var t=e.getData("text/plain");this.handleDropPaste(t)}})}();(function(){var e=r.Formatter.extend({title:"bold",cmd:"bold",keyCode:66,text:"B"}),t=r.Formatter.extend({title:"italic",cmd:"italic",keyCode:73,text:"i"}),n=r.Formatter.extend({title:"link",iconName:"link",cmd:"CreateLink",text:"link",onClick:function(){var e=prompt("Enter a link"),t=/(ftp|http|https):\/\/./;if(e&&e.length>0){t.test(e)||(e="http://"+e);document.execCommand(this.cmd,!1,e)}},isActive:function(){var e=window.getSelection(),t;e.rangeCount>0&&(t=e.getRangeAt(0).startContainer.parentNode);return t&&t.nodeName=="A"}}),i=r.Formatter.extend({title:"unlink",iconName:"link",cmd:"unlink",text:"link"});r.Formatters.Bold=new e;r.Formatters.Italic=new t;r.Formatters.Link=new n;r.Formatters.Unlink=new i})();r.BlockControl=function(){var e=function(e,t){this.type=e;this.instance_scope=t;this._ensureElement();this.initialize()};t.extend(e.prototype,o,u,r.Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.type}},initialize:function(){this.block_type=r.Blocks[this.type].prototype;this.can_be_rendered=this.block_type.toolbarEnabled},render:function(){this.$el.html('<span class="st-icon">'+t.result(this.block_type,"icon_name")+"</span>"+t.result(this.block_type,"title"));return this}});return e}();r.BlockControls=function(){var n=function(e,t){this.instance_scope=t;this.available_types=e||[];this._ensureElement();this._bindFunctions();this.initialize()};t.extend(n.prototype,o,u,r.Events,{bound:["handleControlButtonClick"],block_controls:null,className:"st-block-controls",html:"<a class='st-icon st-icon--close'>close</a>",initialize:function(){for(var e in this.available_types)if(r.Blocks.hasOwnProperty(e)){var t=new r.BlockControl(e,this.instance_scope);t.can_be_rendered&&this.$el.append(t.render().$el)}this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},show:function(){this.$el.addClass("st-block-controls--active")},hide:function(){this.$el.removeClass("st-block-controls--active")},handleControlButtonClick:function(t){t.stopPropagation();this.trigger("createBlock",e(t.currentTarget).attr("data-type"))}});return n}();r.FloatingBlockControls=function(){var n=function(e,t){this.$wrapper=e;this.instance_id=t;this._ensureElement();this._bindFunctions();this.initialize()};t.extend(n.prototype,o,u,r.Events,{className:"st-block-controls__top",attributes:function(){return{"data-icon":"add"}},bound:["handleBlockMouseOut","handleBlockMouseOver","handleBlockClick","onDrop"],initialize:function(){this.$el.on("click",this.handleBlockClick).dropArea().bind("drop",this.onDrop);this.$wrapper.on("mouseover",".st-block",this.handleBlockMouseOver).on("mouseout",".st-block",this.handleBlockMouseOut).on("click",".st-block--with-plus",this.handleBlockClick)},onDrop:function(n){n.preventDefault();var i=this.$el,s=n.originalEvent.dataTransfer.getData("text/plain"),o=e("#"+s);!t.isUndefined(s)&&!t.isEmpty(o)&&i.attr("id")!=s&&this.instance_id==o.attr("data-instance")&&i.after(o);r.EventBus.trigger("block:reorder:dropped",s)},handleBlockMouseOver:function(t){var n=e(t.currentTarget);n.hasClass("st-block--with-plus")||n.addClass("st-block--with-plus")},handleBlockMouseOut:function(t){var n=e(t.currentTarget);n.hasClass("st-block--with-plus")&&n.removeClass("st-block--with-plus")},handleBlockClick:function(t){t.stopPropagation();var n=e(t.currentTarget);this.trigger("showBlockControls",n)}});return n}();r.FormatBar=function(){var n=function(e){this.options=t.extend({},r.DEFAULTS.formatBar,e||{});this._ensureElement();this._bindFunctions();this.initialize.apply(this,arguments)};t.extend(n.prototype,o,r.Events,u,{className:"st-format-bar",bound:["onFormatButtonClick","renderBySelection","hide"],initialize:function(){var t,n,i;this.$btns=[];for(t in r.Formatters)if(r.Formatters.hasOwnProperty(t)){n=r.Formatters[t];i=e("<button>",{"class":"st-format-btn st-format-btn--"+t+" "+(n.iconName?"st-icon":""),text:n.text,"data-type":t,"data-cmd":n.cmd});this.$btns.push(i);i.appendTo(this.$el)}this.$b=e(document);this.$el.bind("click",".st-format-btn",this.onFormatButtonClick)},hide:function(){this.$el.removeClass("st-format-bar--is-ready")},show:function(){this.$el.addClass("st-format-bar--is-ready")},remove:function(){this.$el.remove()},renderBySelection:function(e){var t=window.getSelection(),n=t.getRangeAt(0),r=n.getBoundingClientRect(),i={};i.top=r.top+20+window.pageYOffset-this.$el.height()+"px";i.left=(r.left+r.right)/2-this.$el.width()/2+"px";this.highlightSelectedButtons();this.show();this.$el.css(i)},highlightSelectedButtons:function(){var e;t.each(this.$btns,function(t){e=r.Formatters[t.attr("data-type")];t.toggleClass("st-format-btn--is-active",e.isActive())},this)},onFormatButtonClick:function(n){n.stopPropagation();var i=e(n.target),s=r.Formatters[i.attr("data-type")];if(t.isUndefined(s))return!1;!t.isUndefined(s.onClick)&&t.isFunction(s.onClick)?s.onClick():document.execCommand(i.attr("data-cmd"),!1,s.param);this.highlightSelectedButtons();return!1}});return n}();r.Editor=function(){var n=function(e){r.log("Init SirTrevor.Editor");this.blockTypes={};this.blockCounts={};this.blocks=[];this.errors=[];this.options=t.extend({},r.DEFAULTS,e||{});this.ID=t.uniqueId("st-editor-");if(!this._ensureAndSetElements())return!1;!t.isUndefined(this.options.onEditorRender)&&t.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender);this._setRequired();this._setBlocksTypes();this._bindFunctions();this.store("create");this.build();r.instances.push(this);r.bindFormSubmit(this.$form)};t.extend(n.prototype,o,r.Events,{bound:["onFormSubmit","showBlockControls","hideAllTheThings","hideBlockControls","onNewBlockCreated","changeBlockPosition","onBlockDragStart","onBlockDragEnd","removeBlockDragOver","onBlockDropped","createBlock"],events:{"block:reorder:down":"hideBlockControls","block:reorder:dragstart":"onBlockDragStart","block:reorder:dragend":"onBlockDragEnd","block:content:dropped":"removeBlockDragOver","block:reorder:dropped":"onBlockDropped","block:create:new":"onNewBlockCreated"},initialize:function(){},build:function(){this.$el.hide();this.block_controls=new r.BlockControls(this.blockTypes,this.ID);this.fl_block_controls=new r.FloatingBlockControls(this.$wrapper,this.ID);this.formatBar=new r.FormatBar(this.options.formatBar);this.listenTo(this.block_controls,"createBlock",this.createBlock);this.listenTo(this.fl_block_controls,"showBlockControls",this.showBlockControls);this._setEvents();r.EventBus.on(this.ID+":blocks:change_position",this.changeBlockPosition);r.EventBus.on("formatter:positon",this.formatBar.renderBySelection);r.EventBus.on("formatter:hide",this.formatBar.hide);this.$wrapper.prepend(this.fl_block_controls.render().$el);e(document.body).append(this.formatBar.render().$el);this.$outer.append(this.block_controls.render().$el);e(window).bind("click",this.hideAllTheThings);var n=this.store("read");n.data.length>0?t.each(n.data,function(e){r.log("Creating: "+e.type);this.createBlock(e.type,e.data)},this):this.options.defaultType!==!1&&this.createBlock(this.options.defaultType,{});this.$wrapper.addClass("st-ready");t.isUndefined(this.onEditorRender)||this.onEditorRender()},_setEvents:function(){t.each(this.events,function(e,t){r.EventBus.on(t,this[e],this)},this)},hideAllTheThings:function(e){this.block_controls.hide();this.formatBar.hide();t.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls")},showBlockControls:function(e){t.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls");this.block_controls.show();e.append(this.block_controls.$el.detach());e.addClass("with-st-controls");this.block_controls.current_container=e},store:function(e,t){return r.editorStore(this,e,t||{})},createBlock:function(e,n,i){e=t.capitalize(e);if(this._blockLimitReached()){r.log("Cannot add any more blocks. Limit reached.");return!1}if(!this._isBlockTypeAvailable(e)){r.log("Block type not available "+e);return!1}if(!this._canAddBlockType(e)){r.log("Block Limit reached for type "+e);return!1}var s=new r.Blocks[e](n,this.ID);this._renderInPosition(s.render().$el);this.listenTo(s,"removeBlock",this.removeBlock);this.blocks.push(s);this._incrementBlockTypeCount(e);s.focus();r.EventBus.trigger(n?"block:create:existing":"block:create:new",s);r.log("Block created of type "+e);this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached());this.triggerBlockCountUpdate()},onNewBlockCreated:function(e){this.hideBlockControls();this.scrollTo(e.$el)},scrollTo:function(t){e("html, body").animate({scrollTop:t.position().top},300,"linear")},blockFocus:function(e){this.block_controls.current_container=null},hideBlockControls:function(){t.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls");this.block_controls.hide()},removeBlockDragOver:function(){this.$outer.find(".st-drag-over").removeClass("st-drag-over")},triggerBlockCountUpdate:function(){r.EventBus.trigger(this.ID+":blocks:count_update",this.blocks.length)},changeBlockPosition:function(e,t){t-=1;var n=this.getBlockPosition(e),r=this.$wrapper.find(".st-block").eq(t),i=this.getBlockPosition(r),s=n>t?"Before":"After";if(r&&r.attr("id")!==e.attr("id")){this.hideAllTheThings();e["insert"+s](r);this.scrollTo(e)}},onBlockDropped:function(e){this.hideAllTheThings();var n=this.findBlockById(e);!t.isUndefined(n)&&!t.isEmpty(n.getData())&&n.drop_options.re_render_on_reorder&&n.beforeLoadingData()},onBlockDragStart:function(){this.hideBlockControls();this.$wrapper.addClass("st-outer--is-reordering")},onBlockDragEnd:function(){this.removeBlockDragOver();this.$wrapper.removeClass("st-outer--is-reordering")},_renderInPosition:function(e){this.block_controls.current_container?this.block_controls.current_container.after(e):this.$wrapper.append(e)},_incrementBlockTypeCount:function(e){this.blockCounts[e]=t.isUndefined(this.blockCounts[e])?1:this.blockCounts[e]+1},_getBlockTypeCount:function(e){return t.isUndefined(this.blockCounts[e])?0:this.blockCounts[e]},_canAddBlockType:function(e){var t=this._getBlockTypeLimit(e);return!(t!==0&&this._getBlockTypeCount(e)>=t)},_blockLimitReached:function(){return this.options.blockLimit!==0&&this.blocks.length>=this.options.blockLimit},removeBlock:function(e){var n=this.findBlockById(e),i=n.$el.find(".st-block-controls");if(i.length){this.block_controls.hide();this.$wrapper.prepend(i)}this.blockCounts[n.type]=this.blockCounts[n.type]-1;this.blocks=t.reject(this.blocks,function(e){return e.blockID==n.blockID});this.stopListening(n);n.ajaxable&&n.resolveAllInQueue();n.remove();r.EventBus.trigger("block:remove");this.triggerBlockCountUpdate();this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached())},performValidations:function(e,n){var i=0;if(!r.SKIP_VALIDATION&&n&&!e.valid()){this.errors.push({text:t.result(e,"validationFailMsg")});r.log("Block "+e.blockID+" failed validation");++i}return i},saveBlockStateToStore:function(e){var n=e.saveAndReturnData();if(n&&!t.isEmpty(n.data)){r.log("Adding data for block "+e.blockID+" to block store");this.store("add",{data:n})}},onFormSubmit:function(e){e=e===!1?!1:!0;r.log("Handling form submission for Editor "+this.ID);this.removeErrors();this.store("reset");this.validateBlocks(e);this.validateBlockTypesExist(e);this.renderErrors();this.store("save");return this.errors.length},validateBlocks:function(n){if(!this.required&&r.SKIP_VALIDATION&&!n)return!1;var i=function(r,i){var s=t.find(this.blocks,function(t){return t.blockID==e(r).attr("id")});if(t.isUndefined(s))return!1;this.performValidations(s,n);this.saveBlockStateToStore(s)};t.each(this.$wrapper.find(".st-block"),i,this)},validateBlockTypesExist:function(e){if(!this.required&&r.SKIP_VALIDATION&&!e)return!1;var n=function(e,n){if(this._isBlockTypeAvailable(e))if(this._getBlockTypeCount(e)===0){r.log("Failed validation on required block type "+e);this.errors.push({text:"You must have a block of type "+e})}else{var i=t.filter(this.blocks,function(n){return n.type==e&&!t.isEmpty(n.getData())});if(i.length>0)return!1;this.errors.push({text:"A required block type "+e+" is empty"});r.log("A required block type "+e+" is empty")}};t.isArray(this.required)&&t.each(this.required,n,this)},renderErrors:function(){if(this.errors.length===0)return!1;t.isUndefined(this.$errors)&&(this.$errors=this._errorsContainer());var e="<ul>";t.each(this.errors,function(t){e+='<li class="st-errors__msg">'+t.text+"</li>"});e+="</ul>";this.$errors.append(e);this.$errors.show()},_errorsContainer:function(){if(t.isUndefined(this.options.errorsContainer)){var n=e("<div>",{"class":"st-errors",html:"<p>You have the following errors: </p>"});this.$outer.prepend(n);return n}return i(this.options.errorsContainer)},removeErrors:function(){if(this.errors.length===0)return!1;this.$errors.hide().find("ul").html("");this.errors=[]},findBlockById:function(e){return t.find(this.blocks,function(t){return t.blockID==e})},getBlocksByType:function(e){return t.filter(this.blocks,function(t){return t.type==e})},getBlocksByIDs:function(e){return t.filter(this.blocks,function(n){return t.contains(e,n.blockID)})},getBlockPosition:function(e){return this.$wrapper.find(".st-block").index(e)},_getBlockTypeLimit:function(e){return this._isBlockTypeAvailable(e)?parseInt(t.isUndefined(this.options.blockTypeLimits[e])?0:this.options.blockTypeLimits[e],10):0},_isBlockTypeAvailable:function(e){return!t.isUndefined(this.blockTypes[e])},_ensureAndSetElements:function(){if(t.isUndefined(this.options.el)||t.isEmpty(this.options.el)){r.log("You must provide an el");return!1}this.$el=this.options.el;this.el=this.options.el[0];this.$form=this.$el.parents("form");var n=e("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),i=e("<div>").attr({"class":"st-blocks"});this.$el.wrap(n).wrap(i);this.$outer=this.$form.find("#"+this.ID);this.$wrapper=this.$outer.find(".st-blocks");return!0},_setBlocksTypes:function(){this.blockTypes=t.flattern(t.isUndefined(this.options.blockTypes)?r.Blocks:this.options.blockTypes)},_setRequired:function(){this.required=t.isArray(this.options.required)&&!t.isEmpty(this.options.required)?this.options.required:!1}});return n}();r.setDefaults=function(e){r.DEFAULTS=t.extend(r.DEFAULTS,e||{})};r.bindFormSubmit=function(e){if(!s){r.submittable();e.bind("submit",this.onFormSubmit);s=!0}};r.onBeforeSubmit=function(e){var n=0;t.each(r.instances,function(t,r){n+=t.onFormSubmit(e)});r.log("Total errors: "+n);return n};r.onFormSubmit=function(e){var t=r.onBeforeSubmit();if(t>0){r.EventBus.trigger("onError");e.preventDefault()}};r.setBlockOptions=function(e,n){var i=r.Blocks[e];if(t.isUndefined(i))return;t.extend(i.prototype,n||{})};r.runOnAllInstances=function(e){if(t.has(r.Editor.prototype,e)){[].unshift.call(arguments,r.instances);t.invoke.apply(t,arguments)}else r.log("method doesn't exist")}})(jQuery,_);